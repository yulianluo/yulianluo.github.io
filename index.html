<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="/src/assets/cat.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!-- Start Single Page Apps for GitHub Pages -->
 
  
<script type="module">
  import {markdownTable} from "https://cdn.skypack.dev/markdown-table@3.0.0";

  const Urls = [
    "/cv",
    "/experience",
    "/about",
  ];

  const Deployments = [
    {
      name: "GitHub Pages",
      settings: "" ,
      url: "https://yulianluo.github.io"
    },
  ];

  Deployments.forEach(deployment => {
    if (deployment.url.endsWith("/") ) {
      throw new Error("Please don't include trailing slash in deployment url: " + JSON.stringify(deployment))
    }
  })

  // GH pages urls start with /trailing-slash-guide/ => we don't want the baseurl to pollute the result
  const baseUrlPrefix = window.location.pathname.slice(0,-1); // ignore trailing /
  console.log({baseUrlPrefix})

  function addBaseUrl(url) {
    return `${baseUrlPrefix}${url}`;
  }
  function removeBaseUrl(url) {
    return url.replace(baseUrlPrefix,"");
  }

  async function fetchUrl(url) {
    // Using {redirect: "manual"} is not a good solution => shows status=0 + redirect url is not accessible
    const absoluteUrl = addBaseUrl(url);
    const response = await fetch(absoluteUrl);
    console.log({url, absoluteUrl, response});
    return {
      url,
      absoluteUrl,
      status: response.status, // Note: fetch follows redirects and output status=200
      redirectUrl: response.redirected ? removeBaseUrl(new URL(response.url).pathname) : undefined
    };
  }






  function addUrlResultToDOM(result) {
    const div = document.createElement("div");

    const a = document.createElement('a');
    a.appendChild(document.createTextNode(result.url));
    a.href = result.absoluteUrl;
    div.appendChild(a);

    div.appendChild(document.createTextNode(" - "));

    div.appendChild(formatResultDOM(result));

    document.body.appendChild(div);
  }



  run().catch(e => {
    console.error(e);
    alert("Error, check the console: " + e.message);
  });


  async function runAllDeployments() {

    const CorsProxy = "https://cors.bridged.cc/"

    async function fetchDeploymentUrl(deployment,url) {
      const absoluteUrl = `${deployment.url}${url}`;
      const corsProxyUrl = `${CorsProxy}${absoluteUrl}`;
      const response = await fetch(absoluteUrl);

      // Mostly for GH pages
      function removeDeploymentBaseUrl(str) {
        const baseUrl = new URL(deployment.url).pathname;
        if (baseUrl === "/") {
          return str;
        }
        return str.replace(baseUrl,"");
      }

      // cors proxy impl details :'(
      const finalUrl = response.headers.get("x-final-url");
      const redirectUrl = absoluteUrl !== finalUrl ? removeDeploymentBaseUrl(new URL(finalUrl).pathname) : undefined;

      return {
        url,
        absoluteUrl,
        status: response.status,
        redirectUrl,
      };
    }

    async function getSingleDeploymentResults(deployment) {
      return Promise.all(Urls.map(url => fetchDeploymentUrl(deployment,url)));
    }

    async function getAllDeploymentsResults() {
      return Promise.all(Deployments.map(async deployment => {
        const results = await getSingleDeploymentResults(deployment);
        return {deployment,results};
      }));
    }

    function printMarkdownTable(allDeploymentsResults) {
      const markdownTableString = markdownTable([
        [
          'Host',
          'Settings',
          'Url',
          ...Urls,
        ],
        ...allDeploymentsResults.map(({deployment,results}) => {
          return [
            deployment.name,
            deployment.settings,
            `[link](${deployment.url})`,
            ...results.map(formatResultMarkdown)
          ];
        }),
      ]);
      console.log("\n\n\nmarkdownTableString for all deployments:\n");
      console.log(markdownTableString);
    }

    const allDeploymentsResults = await getAllDeploymentsResults();
    printMarkdownTable(allDeploymentsResults);
  }

  runAllDeployments();


    </script>
    <!-- End Single Page Apps for GitHub Pages -->
    <title>Yulian Luo</title>
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.js"></script>
  </body>
</html>
